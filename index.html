<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrology - La Esencia del Pilates</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="IMG/favicon.webp" type="image/webp">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        body { font-family: 'Lato', sans-serif; background-color: #f8f7f5; color: #333; }
        h1, h2, h3, h4, h5, h6 { font-family: 'Montserrat', sans-serif; }
        .hero-bg { background-image: url('IMG/hero-bg.webp'); background-size: cover; background-position: center; }
        .btn-primary { @apply bg-[#8a7968] text-white py-3 px-8 rounded-full font-bold tracking-wider uppercase text-sm hover:bg-[#6e6054] transition-all duration-300; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .prose-custom ul { @apply list-disc list-inside mb-4; }
        .prose-custom li { @apply mb-2; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .day-column h3 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
        .class-card { background-color: #fef08a; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; transition: all 0.2s ease-in-out; }
        .class-card-time { font-weight: bold; font-size: 1.125rem; }
        .class-card-name { color: #8a7968; font-weight: 500; }
        .class-card-spots { font-size: 0.875rem; color: #4b5563; }
        .btn-action { @apply w-full mt-4 py-2 px-4 rounded-md font-bold text-sm text-white transition-all; }
        .btn-book { @apply bg-green-600 hover:bg-green-700; }
        .btn-cancel { @apply bg-red-600 hover:bg-red-700; }
        .btn-full { @apply bg-gray-400 cursor-not-allowed; }
        .card-booked { background-color: #fef08a; border-color: #10b981; }

        @media (max-width: 768px) {
            .hero-bg { background-image: url('IMG/hero-bg-mobile.webp'); }
            #cookie-banner { left: 1rem; bottom: 1rem; right: 5.5rem; max-width: none; }
        }
    </style>
</head>
<body class="antialiased">

    <div id="cookie-banner" class="fixed bottom-4 left-4 max-w-lg bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50 flex items-center gap-4 fade-in">
        <p class="text-sm">Este sitio web utiliza cookies para mejorar tu experiencia. Al continuar, aceptas nuestra <a href="cookies.html" class="underline">Política de Cookies</a>.</p>
        <button id="accept-cookies" class="bg-gray-200 text-gray-800 text-xs font-bold py-2 px-4 rounded-full flex-shrink-0">Aceptar</button>
    </div>

    <header id="header" class="bg-white/80 backdrop-blur-md sticky top-0 z-40 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="h-10">
                <img src="IMG/logo.webp" alt="Logo de Contrology" class="h-full">
            </a>
            <nav class="hidden md:flex space-x-8 items-center">
                <a href="dashboard-profesora.html" id="nav-dashboard" class="text-white bg-gray-700 px-3 py-1 rounded-md text-sm font-bold" style="display: none;">Dashboard</a>
                <a href="#inicio" class="text-gray-600 hover:text-[#8a7968] transition-colors">Inicio</a>
                <a href="#horarios" class="text-gray-600 hover:text-[#8a7968] transition-colors">Horarios</a>
                <a href="#rutina" id="nav-rutina" class="text-gray-600 hover:text-[#8a7968] transition-colors" style="display: none;">Mi Rutina</a>
                <a href="#educacion" class="text-gray-600 hover:text-[#8a7968] transition-colors">Educación</a>
                <a href="#contacto" class="text-gray-600 hover:text-[#8a7968] transition-colors">Contacto</a>
            </nav>
            <div class="flex items-center space-x-2">
                <span id="user-email-index" class="text-gray-600 text-sm"></span>
                <div data-netlify-identity-button></div>
            </div>
        </div>
    </header>

    <main>
        <section id="inicio" class="relative h-screen flex items-center justify-center text-white hero-bg">
            <div class="absolute inset-0 bg-black/50"></div>
            <div class="relative z-10 text-center p-6 fade-in">
                <h1 class="text-5xl md:text-7xl font-bold leading-tight mb-4">Redescubre la esencia de tu movimiento</h1>
                <p class="text-lg md:text-xl max-w-2xl mx-auto mb-8">En Contrology,creemos en el poder transformador del pilates para conectar cuerpo, mente y espíritu.</p>
                <a href="#horarios" class="btn-primary">Ver Horarios</a>
            </div>
        </section>

        <section id="horarios" class="py-20">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4">Nuestros Horarios</h2>
                <p class="text-gray-600 max-w-2xl mx-auto mb-12">Agenda siempre actualizada en tiempo real para tu comodidad. Elige tu momento ideal y reserva tu lugar.</p>
                <div id="schedule-container" class="bg-white p-8 rounded-lg shadow-lg border border-gray-200 text-left">
                    <p class="text-lg text-gray-700 text-center">Cargando agenda...</p>
                </div>
            </div>
        </section>

        <section id="reserva" class="bg-white py-20">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4">Reserva tu Lugar</h2>
                <p class="text-gray-600 max-w-2xl mx-auto mb-12">Asegura tu clase realizando el pago a través de transferencia. Tu espacio es exclusivo y te espera.</p>
                <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-lg shadow-md border-2 border-gray-200">
                    <h3 class="text-2xl font-semibold text-[#6e6054] mb-4">Datos para la Transferencia</h3>
                    <div class="mb-6">
                        <p class="text-sm text-gray-500">CVU (FWIND PAY)</p>
                        <div class="flex items-center justify-center mt-1">
                            <p id="cvu-text" class="text-lg font-mono bg-gray-200 px-4 py-2 rounded-l-md">0000267900000000175771</p>
                            <button onclick="copyToClipboard()" class="bg-[#8a7968] text-white px-4 py-2 rounded-r-md hover:bg-[#6e6054] transition">Copiar</button>
                        </div>
                        <span id="copy-feedback" class="text-sm text-green-600 opacity-0 transition-opacity">¡Copiado!</span>
                    </div>
                    <div class="text-left text-sm bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md">
                        <p class="font-bold">¡Importante!</p>
                        <p class="mt-2">Para confirmar tu reserva, por favor, envía el comprobante legible por WhatsApp.</p>
                        <a href="https://wa.me/5492995354215" target="_blank" class="font-bold underline hover:text-yellow-800">Enviar comprobante aquí.</a>
                        <p class="mt-3 text-xs">La inasistencia a la clase no es reembolsable, ya que tu lugar es exclusivamente guardado para ti.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="rutina" class="py-20 bg-white" style="display: none;">
            <div class="container mx-auto px-6 text-center">
                <h2 class="text-4xl font-bold mb-4">Tu Rutina Complementaria</h2>
                <p class="text-gray-600 max-w-3xl mx-auto mb-12">Esta seccion la diseñe, para esos días que no puedes asistir al estudio. Úsala como un complemento en tus viajes o vacaciones, pero recuerda que nada reemplaza la guía y corrección personalizada de una clase presencial.</p>
                <div class="max-w-2xl mx-auto bg-gray-50 p-8 rounded-lg shadow-md border-2 border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="objetivo" class="block text-left text-sm font-bold mb-2 text-gray-700">Mi objetivo principal es...</label>
                            <input type="text" id="objetivo" placeholder="Ej: fortalecer abdomen" class="w-full px-4 py-3 rounded-lg bg-white border-2 border-gray-200 focus:border-[#8a7968] focus:outline-none transition">
                        </div>
                        <div>
                            <label for="nivel" class="block text-left text-sm font-bold mb-2 text-gray-700">Mi nivel de experiencia es...</label>
                            <select id="nivel" class="w-full px-4 py-3 rounded-lg bg-white border-2 border-gray-200 focus:border-[#8a7968] focus:outline-none transition">
                                <option>Principiante</option>
                                <option>Intermedio</option>
                                <option>Avanzado</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-8">
                        <label for="tiempo" class="block text-left text-sm font-bold mb-2 text-gray-700">Tengo disponibles...</label>
                        <input type="text" id="tiempo" placeholder="Ej: 20 minutos" class="w-full px-4 py-3 rounded-lg bg-white border-2 border-gray-200 focus:border-[#8a7968] focus:outline-none transition">
                    </div>
                    <button id="generate-routine-btn" class="btn-primary w-full">Generar Rutina</button>
                </div>
                <div id="routine-result-container" class="mt-12 text-left max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg prose-custom border-2 border-gray-200" style="display: none;"></div>
            </div>
        </section>

        <section id="educacion" class="py-20">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-bold text-center mb-12">Expande tu Conocimiento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <img src="IMG/educacion-historia.webp" alt="Historia del Pilates" class="rounded-md mb-4 w-full h-48 object-cover">
                        <h3 class="text-2xl font-semibold mb-3">Historia y Filosofía</h3>
                        <p class="text-gray-600 mb-4">Descubre los orígenes del método y la fascinante vida de Joseph Pilates.</p>
                        <a href="educacion-historia.html" class="font-bold text-[#8a7968] hover:underline">Leer más →</a>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <img src="IMG/educacion-principios.webp" alt="Principios Fundamentales del Pilates" class="rounded-md mb-4 w-full h-48 object-cover">
                        <h3 class="text-2xl font-semibold mb-3">Los 6 Principios Fundamentales</h3>
                        <p class="text-gray-600 mb-4">Respiración, control, centro. Domina los pilares que sostienen cada movimiento.</p>
                        <a href="educacion-principios.html" class="font-bold text-[#8a7968] hover:underline">Leer más →</a>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <img src="IMG/educacion-anatomia.webp" alt="Anatomía y Biomecánica del Pilates" class="rounded-md mb-4 w-full h-48 object-cover">
                        <h3 class="text-2xl font-semibold mb-3">Anatomía y Biomecánica</h3>
                        <p class="text-gray-600 mb-4">Entiende cómo el Pilates trabaja con tu cuerpo para lograr resultados seguros y efectivos.</p>
                        <a href="educacion-anatomia.html" class="font-bold text-[#8a7968] hover:underline">Leer más →</a>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <img src="IMG/educacion-terapeutico.webp" alt="Pilates Terapéutico" class="rounded-md mb-4 w-full h-48 object-cover">
                        <h3 class="text-2xl font-semibold mb-3">Pilates Terapéutico</h3>
                        <p class="text-gray-600 mb-4">Un camino hacia la recuperación y la prevención de lesiones a través del movimiento consciente.</p>
                        <a href="educacion-terapeutico.html" class="font-bold text-[#8a7968] hover:underline">Leer más →</a>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <img src="IMG/educacion-nutricion.webp" alt="Nutrición Consciente y Pilates" class="rounded-md mb-4 w-full h-48 object-cover">
                        <h3 class="text-2xl font-semibold mb-3">Nutrición Consciente</h3>
                        <p class="text-gray-600 mb-4">Nutre tu cuerpo para potenciar tu práctica y alcanzar tus metas de bienestar.</p>
                        <a href="educacion-nutricion.html" class="font-bold text-[#8a7968] hover:underline">Leer más →</a>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-sm hover:shadow-xl transition-shadow duration-300">
                        <h3 class="text-2xl font-semibold mb-3">Ver Más...</h3>
                        <p class="text-gray-600 mb-4">Explora todos nuestros artículos educativos y profundiza en tu práctica.</p>
                        <a href="#educacion" class="font-bold text-[#8a7968] hover:underline">Explorar todo →</a>
                    </div>
                </div>
            </div>
        </section>

        <section id="contacto" class="py-20">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-bold text-center mb-4">¿Hablamos?</h2>
                <p class="text-gray-600 max-w-2xl mx-auto text-center mb-12">Si tienes cualquier duda, envíame un mensaje. Será un placer ayudarte a comenzar.</p>
                <form action="https://formsubmit.co/toby39478@gmail.com" method="POST" class="max-w-xl mx-auto bg-white p-8 rounded-lg shadow-lg border-2 border-gray-200">
                    <input type="hidden" name="_next" value="https://contrology.netlify.app/gracias.html">
                    <input type="hidden" name="_subject" value="Nuevo mensaje desde la web de Contrology">
                    <input type="hidden" name="_captcha" value="false">
                    <div class="mb-6">
                        <label for="name" class="block text-gray-700 text-sm font-bold mb-2">Nombre</label>
                        <input type="text" name="name" id="name" required class="w-full px-4 py-3 rounded-lg bg-gray-100 border-2 border-transparent focus:border-[#8a7968] focus:bg-white focus:outline-none transition">
                    </div>
                    <div class="mb-6">
                        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico</label>
                        <input type="email" name="email" id="email" required class="w-full px-4 py-3 rounded-lg bg-gray-100 border-2 border-transparent focus:border-[#8a7968] focus:bg-white focus:outline-none transition">
                    </div>
                    <div class="mb-8">
                        <label for="message" class="block text-gray-700 text-sm font-bold mb-2">Mensaje</label>
                        <textarea name="message" id="message" rows="5" required class="w-full px-4 py-3 rounded-lg bg-gray-100 border-2 border-transparent focus:border-[#8a7968] focus:bg-white focus:outline-none transition"></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn-primary">Enviar Mensaje</button>
                    </div>
                </form>
            </div>
        </section>

        <div id="chat-widget-container">
            <button id="chat-toggle" class="fixed bottom-6 right-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center z-40 transition-transform hover:scale-110">
                <img src="IMG/chat-icon.webp" alt="Asistente Virtual" class="w-10 h-10">
            </button>
            <div id="chat-window" class="hidden fixed bottom-28 right-6 w-96 bg-white rounded-lg shadow-xl z-40 fade-in">
                <div class="p-4 bg-[#6e6054] text-white rounded-t-lg">
                    <h4 class="font-bold">Asistente Virtual Contrology</h4>
                    <p class="text-xs">Hola, soy tu asistente virtual. ¿Cómo puedo ayudarte?</p>
                </div>
                <div id="chat-body" class="p-4 h-80 overflow-y-auto"></div>
                 <div class="p-4 border-t flex">
                    <input id="chat-input" type="text" placeholder="Escribe tu mensaje..." class="flex-grow w-full px-3 py-2 border rounded-l-lg focus:outline-none focus:ring-2 focus:ring-[#8a7968]">
                    <button id="chat-send" class="bg-[#8a7968] text-white px-4 rounded-r-lg">Enviar</button>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-6 text-center">
            <p class="text-xl font-bold mb-4">Contrology</p>
            <p class="mb-6 text-gray-400">La Esencia del Pilates. C.S.Río Negro.</p>
            <div class="text-xs text-gray-500 border-t border-gray-700 pt-6">
                <p>© <span id="year"></span> Contrology. Todos los derechos reservados.</p>
                <p class="mt-2">
                    <a href="terminos.html" class="underline hover:text-white">Términos y Condiciones</a> ·
                    <a href="privacidad.html" class="underline hover:text-white">Política de Privacidad</a> ·
                    <a href="cookies.html" class="underline hover:text-white">Política de Cookies</a>
                </p>
                 <p class="mt-4 text-gray-600">Diseño y Desarrollo por 
                    <a href="https://repfinity.app" target="_blank" class="underline hover:text-white">Repfinity</a>
                </p>
            </div>
        </div>
    </footer>

    <script>
        document.getElementById('accept-cookies').addEventListener('click', function() {
            document.getElementById('cookie-banner').style.display = 'none';
        });

        document.getElementById('year').textContent = new Date().getFullYear();

        document.getElementById('chat-toggle').addEventListener('click', () => {
            document.getElementById('chat-window').classList.toggle('hidden');
        });
        
        function copyToClipboard() {
            const cvuText = document.getElementById('cvu-text').innerText;
            navigator.clipboard.writeText(cvuText).then(() => {
                const feedback = document.getElementById('copy-feedback');
                feedback.style.opacity = '1';
                setTimeout(() => { feedback.style.opacity = '0'; }, 2000);
            });
        }

        const generateRoutineBtn = document.getElementById('generate-routine-btn');
        const routineResultContainer = document.getElementById('routine-result-container');
        
        generateRoutineBtn.addEventListener('click', async () => {
            const objetivo = document.getElementById('objetivo').value;
            const nivel = document.getElementById('nivel').value;
            const tiempo = document.getElementById('tiempo').value;

            if (!objetivo || !tiempo) {
                alert('Por favor, completa tu objetivo y el tiempo disponible.');
                return;
            }

            const prompt = `Crea una rutina de Pilates como complemento para los días en que el alumno no puede asistir a clase (por viaje, vacaciones, etc.). Enfatiza que esta rutina no reemplaza la guía de un instructor. La rutina es para una persona de nivel ${nivel} que quiere enfocarse en ${objetivo} y tiene ${tiempo} disponibles. La rutina debe ser clara, segura y estar lista para seguir. Formatea la respuesta con un título H3, una breve introducción en un párrafo, y luego una lista de ejercicios con el número de repeticiones sugeridas para cada uno.`;
            
            routineResultContainer.style.display = 'block';
            routineResultContainer.innerHTML = '<p>Generando tu rutina personalizada... ✨</p>';
            
            try {
                const response = await fetch(`${window.location.origin}/.netlify/functions/groq-routine`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt }),
                });

                if (!response.ok) throw new Error(`Error en la respuesta del servidor: ${response.statusText}`);
                
                const result = await response.json();
                routineResultContainer.innerHTML = result.reply;
            } catch (error) {
                console.error("Error al generar la rutina:", error);
                routineResultContainer.innerHTML = `<p>Lo siento, ha ocurrido un error. Por favor, intenta de nuevo más tarde.</p>`;
            }
        });

        const chatSendBtn = document.getElementById('chat-send');
        const chatInput = document.getElementById('chat-input');
        const chatBody = document.getElementById('chat-body');

        function addMessageToChat(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 text-sm ${sender === 'user' ? 'text-right' : 'text-left'}`;
            const messageP = document.createElement('p');
            messageP.className = `rounded-lg p-3 inline-block ${sender === 'user' ? 'bg-[#8a7968] text-white' : 'bg-gray-200 text-gray-800'}`;
            messageP.textContent = message;
            messageDiv.appendChild(messageP);
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function getChatbotResponse(userMessage) {
            try {
                 const response = await fetch(`${window.location.origin}/.netlify/functions/groq-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userQuery: userMessage }),
                });
                if (!response.ok) throw new Error('Error en la respuesta del chatbot.');
                const result = await response.json();
                return result.reply;
            } catch (error) {
                 console.error("Error en el chatbot:", error);
                return "Lo siento, estoy teniendo problemas para conectarme.";
            }
        }
        
        chatSendBtn.addEventListener('click', async () => {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessageToChat(userMessage, 'user');
            chatInput.value = '';
            
            addMessageToChat('...', 'bot');

            const botResponse = await getChatbotResponse(userMessage);

            chatBody.removeChild(chatBody.lastChild);
            addMessageToChat(botResponse, 'bot');
        });
        
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                chatSendBtn.click();
            }
        });
        
        const rutinaSection = document.getElementById('rutina');
        const rutinaNav = document.getElementById('nav-rutina');
        const dashboardNav = document.getElementById('nav-dashboard');
        const scheduleContainer = document.getElementById('schedule-container');

        async function renderSchedule(user, isAdmin) { // Añadido isAdmin como parámetro
            scheduleContainer.innerHTML = '<p class="text-lg text-gray-700 text-center">Cargando agenda...</p>';
            
            const endpoint = (window.location.hash === '#rutina' && user) ? '/.netlify/functions/get-private-schedule' : '/.netlify/functions/get-schedule-v2';
            const headers = { 'Cache-Control': 'no-cache' };
            if (user && user.token) {
                headers['Authorization'] = `Bearer ${user.token.access_token}`;
            }

            try {
                const response = await fetch(endpoint, { headers });
                if(!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Error al cargar los horarios desde el servidor.');
                }

                const scheduleData = await response.json();

                if (scheduleData.length === 0) {
                    scheduleContainer.innerHTML = '<p class="text-center">No hay clases programadas en este momento.</p>';
                    return;
                }
                
                const diasSemana = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
                const groupedSchedule = scheduleData.reduce((acc, clase) => {
                    const dayName = diasSemana[clase.dia_semana];
                    if (!acc[dayName]) {
                        acc[dayName] = [];
                    }
                    acc[dayName].push(clase);
                    return acc;
                }, {});

                let scheduleHtml = '<div class="schedule-grid">';

                for (const day of ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"]) {
                    if (groupedSchedule[day]) {
                        scheduleHtml += `<div class="day-column"><h3>${day}</h3><div class="space-y-4">`;
                        
                        groupedSchedule[day].forEach(clase => {
                            let cardStyle = 'class-card';
                            let buttonHtml = '';

                            // Modificación aquí: Solo mostrar botones si el usuario está logueado Y NO es admin
                            if (user && !isAdmin) { 
                                if (clase.isBookedByUser) {
                                    cardStyle += ' card-booked';
                                    buttonHtml = `<button class="btn-action btn-cancel" data-class-id="${clase.id}">Cancelar</button>`;
                                } else if (clase.disponibles > 0) {
                                    buttonHtml = `<button class="btn-action btn-book" data-class-id="${clase.id}">Reservar</button>`;
                                } else {
                                    buttonHtml = `<button class="btn-action btn-full" disabled>Completo</button>`;
                                }
                            }

                            scheduleHtml += `
                                <div class="${cardStyle}" data-class-id-wrapper="${clase.id}">
                                    <p class="class-card-time">${clase.hora}</p>
                                    <p class="class-card-name">${clase.nombre}</p>
                                    <p class="class-card-spots mt-2">${clase.anotados} anotados</p>
                                    <p class="class-card-spots">${clase.disponibles} disponibles</p>
                                    ${clase.isBookedByUser ? `<p class="text-xs text-green-700 font-bold mt-1">Tú estás anotado (${user.user_metadata.full_name || user.email})</p>` : ''}
                                    ${buttonHtml}
                                </div>
                            `;
                        });

                        scheduleHtml += '</div></div>';
                    }
                }

                scheduleHtml += '</div>';
                scheduleContainer.innerHTML = scheduleHtml;

            } catch (error) {
                console.error('Error al cargar la agenda:', error);
                scheduleContainer.innerHTML = `<p class="text-center text-red-500">${error.message}</p>`;
            }
        }
        
        async function handleBookingAction(classId, action) {
            const user = netlifyIdentity.currentUser();
            if (!user) {
                alert('Debes iniciar sesión para realizar esta acción.');
                return;
            }

            const button = document.querySelector(`button[data-class-id="${classId}"]`);
            button.disabled = true;
            button.textContent = 'Procesando...';

            try {
                const response = await fetch(`/.netlify/functions/${action}-class`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${user.token.access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ classId: classId })
                });

                if (!response.ok) {
                    const result = await response.json();
                    throw new Error(result.error || 'Ocurrió un error.');
                }
                
                // Determinar isAdmin de forma segura
                const currentUser = netlifyIdentity.currentUser();
                const isAdmin = currentUser && currentUser.app_metadata && currentUser.app_metadata.roles && currentUser.app_metadata.roles.includes('admin');
                renderSchedule(user, isAdmin);

            } catch (error) {
                alert(`Error: ${error.message}`);
                // Determinar isAdmin de forma segura incluso en caso de error
                const currentUser = netlifyIdentity.currentUser();
                const isAdmin = currentUser && currentUser.app_metadata && currentUser.app_metadata.roles && currentUser.app_metadata.roles.includes('admin');
                renderSchedule(user, isAdmin);
            }
        }

        scheduleContainer.addEventListener('click', function(event) {
            if (event.target.matches('.btn-book')) {
                const classId = event.target.dataset.classId;
                handleBookingAction(classId, 'book');
            }
            if (event.target.matches('.btn-cancel')) {
                const classId = event.target.dataset.classId;
                handleBookingAction(classId, 'cancel');
            }
        });

        const updateUserUI = (user) => {
            const isAdmin = user && user.app_metadata && user.app_metadata.roles && user.app_metadata.roles.includes('admin');
            const userEmailIndexSpan = document.getElementById('user-email-index');

            if (user) {
                rutinaSection.style.display = 'block';
                rutinaNav.style.display = 'block';
                userEmailIndexSpan.textContent = user.email;
            } else {
                rutinaSection.style.display = 'none';
                rutinaNav.style.display = 'none';
                userEmailIndexSpan.textContent = '';
            }

            if (isAdmin) {
                dashboardNav.style.display = 'block';
            } else {
                dashboardNav.style.display = 'none';
            }
            renderSchedule(user, isAdmin); // Pasar isAdmin a renderSchedule
        };

        netlifyIdentity.on('init', user => {
            updateUserUI(user);
        });

        netlifyIdentity.on('login', user => {
            updateUserUI(user);
            netlifyIdentity.close();
        });

        netlifyIdentity.on('logout', () => {
            updateUserUI(null);
        });
    </script>
    
</body>
</html>